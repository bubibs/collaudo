<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report di Messa in Fase Macchinario</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 15px;
            color: #333;
            line-height: 1.6;
            background-color: #f4f7f6;
        }
        .container {
            max-width: 800px;
            margin: auto;
            border: 1px solid #e0e0e0;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #fff;
            border-radius: 8px;
        }
        h1, h2, h3 {
            color: #1a5276;
            border-bottom: 2px solid #aebfd0;
            padding-bottom: 8px;
            margin-top: 25px;
        }
        h1 {
            text-align: center;
            font-size: 1.8em;
        }
        h2 {
            font-size: 1.4em;
        }
        h3 {
            font-size: 1.2em;
        }
        .section {
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.95em;
        }
        .form-group input[type="text"], .form-group textarea, .form-group select, .form-group input[type="number"], .form-group input[type="date"] {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .form-group input[type="checkbox"] {
            margin-right: 8px;
        }
        .checklist-item {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .checklist-item .item-header {
            display: flex;
            align-items: center;
            font-weight: bold;
        }
        .checklist-item .item-header input[type="checkbox"] {
            margin-right: 10px;
            min-width: 18px;
            min-height: 18px;
        }
        .checklist-item .item-notes, .checklist-item .item-measurement {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .measurement-group {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 8px;
            margin-top: 5px;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .measurement-group input[type="text"] {
            width: 100%;
            padding: 6px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .image-container {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .image-preview {
            max-width: 100px;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .upload-btn {
            background-color: #1a5276;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 0.9em;
            display: block;
            margin-top: 5px;
        }
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 20px;
            margin-bottom: 25px;
            overflow: hidden;
        }
        .progress-bar {
            width: 0%;
            height: 25px;
            background-color: #4CAF50;
            text-align: center;
            line-height: 25px;
            color: white;
            border-radius: 5px;
            transition: width 0.3s ease-in-out;
            font-weight: bold;
        }
        .signature-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 40px;
        }
        .signature-box {
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
            width: 100%;
        }
        .hidden-input {
            display: none;
        }
        
        /* Gestione macchinari e configurazione */
        #machineManagement {
            background-color: #e6f0f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        #machineManagement select, #machineNameInput {
            width: 100%;
            margin-bottom: 10px;
        }
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .add-btn {
            background-color: #28a745;
            color: white;
            width: 100%;
            margin-top: 10px;
            padding: 12px 20px;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .pdf-btn, .manage-btn, .save-btn, .new-machine-btn, #loadReportBtn, #deleteMachineBtn {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        #deleteMachineBtn {
            background-color: #dc3545;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        
        /* Modale per visualizzazione foto */
        #photoModal, #confirmModal, #deleteMachineModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }
        #photoModal {
            background-color: rgba(0,0,0,0.9);
        }
        #modalImage {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        /* Stili per la configurazione a una colonna */
        #configSection {
            display: none;
            background-color: #e6f0f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        .config-item {
            background-color: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }
        .config-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
        }
        .config-item-content {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .config-item.active .config-item-content {
            display: flex;
        }
        .config-item .btn-group {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            margin-top: 5px;
        }
        .sortable-list .config-item:hover {
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .handle {
            cursor: grab;
            margin-right: 10px;
            font-size: 1.5em;
            line-height: 1;
        }
        /* Modale di conferma */
        #confirmModal .modal-content, #deleteMachineModal .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            position: relative;
        }
        #confirmModal h3, #deleteMachineModal h3 {
            margin-top: 0;
            color: #dc3545;
        }
        #confirmModal p, #deleteMachineModal p {
            margin-bottom: 20px;
        }
        #confirmModal .button-group, #deleteMachineModal .button-group {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        #confirmModal .button-group button, #deleteMachineModal .button-group button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        #confirmModal #confirmDeleteBtn, #deleteMachineModal #confirmDeleteMachineBtn {
            background-color: #dc3545;
            color: white;
        }
        #confirmModal #cancelDeleteBtn, #deleteMachineModal #cancelDeleteMachineBtn {
            background-color: #6c757d;
            color: white;
        }
        
        /* Message Box */
        #messageBox {
            display: block;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1001;
            font-size: 1.1em;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none; /* Rende il box non cliccabile */
        }
        
        /* Stili per la stampa */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            body {
                font-family: 'Times New Roman', Times, serif;
                font-size: 11pt;
                line-height: 1.4;
                background-color: #fff;
                color: #000;
            }

            .container {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
            }
            
            /* Nascondi elementi non stampabili */
            .upload-btn, .hidden-input, .manage-btn, #configSection, .pdf-btn, .add-btn, .delete-btn, .toggle-btn, #machineManagement, #photoModal, .handle, #messageBox, #saveReportBtn, #loadReportBtn, .modal-close {
                display: none !important;
            }

            /* Frontespizio */
            .cover-page {
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                text-align: center;
                padding: 50mm 15mm 20mm;
                box-sizing: border-box;
                page-break-after: always;
            }
            .cover-page h1 {
                font-size: 36pt;
                color: #1a5276;
                border-bottom: 2pt solid #000;
                padding-bottom: 15px;
            }
            .cover-page h2 {
                font-size: 24pt;
                margin-top: 20px;
            }
            .company-logo {
                width: 150px;
                height: auto;
                margin-bottom: 50px;
            }
            .report-details {
                width: 100%;
                text-align: left;
                font-size: 12pt;
                margin-top: 50px;
            }
            .report-details p {
                margin: 10px 0;
            }
            .report-details span {
                font-weight: bold;
            }
            .cover-footer {
                margin-top: auto;
                font-size: 10pt;
                color: #666;
            }

            /* Report Body */
            .main-report-body {
                padding: 2cm 1.5cm;
            }

            /* Intestazioni */
            h1, h2, h3 {
                border-bottom: 1pt solid #ccc;
                padding-bottom: 5px;
                margin-top: 30px;
                page-break-after: avoid;
            }
            h1 { font-size: 18pt; }
            h2 { font-size: 14pt; }
            h3 { font-size: 12pt; }

            /* Campi e input */
            .form-group label {
                font-weight: bold;
                display: inline-block;
                width: 150px;
                vertical-align: top;
            }
            .form-group input, .form-group textarea {
                border: none;
                background: none;
                padding: 0;
                border-bottom: 1px dashed #999;
                width: calc(100% - 160px);
            }
            .form-group textarea {
                border: 1px dashed #999;
                min-height: 50px;
                display: block;
                width: 100%;
            }
            
            /* Checklist */
            .checklist-item {
                border: 1px solid #ddd;
                padding: 15px;
                margin-bottom: 15px;
                border-radius: 0;
                background-color: #f9f9f9;
                page-break-inside: avoid;
            }
            .checklist-item .item-header label {
                display: inline;
                font-weight: bold;
            }
            .checklist-item .item-notes, .checklist-item .item-measurement {
                border: 1px dashed #999;
                padding: 5px;
            }
            .measurement-group {
                border: none;
                padding: 0;
                background-color: transparent;
            }
            .measurement-group input {
                width: auto;
            }

            /* Foto */
            .photo-section {
                page-break-before: always;
            }
            .photo-section h2 {
                margin-bottom: 20px;
            }
            .photo-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-bottom: 20px;
                page-break-inside: avoid;
            }
            .photo-item img {
                max-width: 80%;
                height: auto;
                border: 1px solid #ccc;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                margin-bottom: 5px;
            }
            .photo-item p {
                font-style: italic;
                font-size: 10pt;
                text-align: center;
                max-width: 80%;
            }

            /* Firme */
            .signature-area {
                margin-top: 50px;
            }
            .signature-box {
                border-bottom: 1px solid #000;
                padding-bottom: 20px;
                width: 45%;
                display: inline-block;
                margin-right: 5%;
                vertical-align: top;
            }
            
            /* Barra di progresso */
            .progress-container { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <button id="generatePdfBtn" class="pdf-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8c-.55 0-1-.45-1-1s.45-1 1-1h8c.55 0 1 .45 1 1s-.45 1-1 1zm0-4H8c-.55 0-1-.45-1-1s.45-1 1-1h8c.55 0 1 .45 1 1s-.45 1-1 1zm-3-5V3.5L18.5 9H13z"/></svg>Genera Report PDF</button>

    <div id="mainReportContent">
        <div class="cover-page" id="coverPage">
            <img src="https://via.placeholder.com/150" alt="Logo Azienda" class="company-logo">
            <h1>Report di Intervento Tecnico</h1>
            <h2>Manutenzione e Messa in Fase Macchinario</h2>
            <div class="report-details">
                <p><span>Oggetto:</span> Messa in Fase e Test Macchinario</p>
                <p><span>Cliente:</span> N/A</p>
                <p><span>Data Report:</span> <span id="reportDate"></span></p>
            </div>
            <div class="cover-footer">
                <p>Generato automaticamente da: Report di Messa in Fase v1.0</p>
            </div>
        </div>
        
        <div class="main-report-body">
            <div class="section">
                <h2>Dettagli dell'Intervento</h2>
                <div class="form-group">
                    <label for="macchinario">Nome Macchinario:</label>
                    <input type="text" id="macchinario" name="macchinario">
                </div>
                <div class="form-group">
                    <label for="modello">Modello:</label>
                    <input type="text" id="modello" name="modello">
                </div>
                <div class="form-group">
                    <label for="seriale">Numero di Serie:</label>
                    <input type="text" id="seriale" name="seriale">
                </div>
            </div>
            
            <div class="section">
                <h2>Lista di Controllo e Verifica</h2>
                <div id="checklistItems"></div>
            </div>
            
            <div class="section photo-section">
                <h2>Documentazione Fotografica</h2>
                <div id="allPhotos"></div>
            </div>
            
            <div class="section">
                <h2>Riepilogo e Note Finali</h2>
                <div class="form-group">
                    <label for="azioni-correttive">Riepilogo delle azioni correttive:</label>
                    <textarea id="azioni-correttive" name="azioni-correttive" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="note-aggiuntive">Note aggiuntive:</label>
                    <textarea id="note-aggiuntive" name="note-aggiuntive" rows="4"></textarea>
                </div>
            </div>
            
            <div class="section">
                <h2>Approvazione</h2>
                <div class="signature-area">
                    <div class="signature-box">Operatore:</div>
                    <div class="signature-box">Responsabile Cliente:</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
    const generatePdfBtn = document.getElementById('generatePdfBtn');
    const mainReportContent = document.getElementById('mainReportContent');
    const macchinarioField = document.getElementById('macchinario');
    const checklistDiv = document.getElementById('checklistItems');
    const allPhotosDiv = document.getElementById('allPhotos');
    
    // Funzione fittizia per riempire i dati del report. Sostituisci con i tuoi dati reali.
    function loadReportData() {
        const reportData = {
            details: {
                macchinario: 'Fresatrice CNC - Mod. 3000',
                modello: 'CNC-F3000',
                seriale: 'XYZ-123456789'
            },
            checklistItems: [
                { id: '1', description: 'Verifica allineamento cinghie', notes: 'Allineamento perfetto.', images: ['https://via.placeholder.com/400x300?text=Cinghia+Allineata'] },
                { id: '2', description: 'Controllo tensione catene', notes: 'Tensione corretta, nessun intervento.', images: ['https://via.placeholder.com/400x300?text=Tensione+Catena'] },
                { id: '3', description: 'Regolazione gioco ingranaggi', notes: 'Regolato gioco su 0.05 mm.', images: ['https://via.placeholder.com/400x300?text=Ingranaggi'] },
            ],
            finalNotes: {
                azioniCorrettive: 'Sostituzione sensore di prossimità difettoso.',
                noteAggiuntive: 'Macchinario testato per 2 ore, funzionamento regolare.'
            }
        };

        // Popola i campi
        macchinarioField.value = reportData.details.macchinario;
        document.getElementById('modello').value = reportData.details.modello;
        document.getElementById('seriale').value = reportData.details.seriale;
        document.getElementById('azioni-correttive').value = reportData.finalNotes.azioniCorrettive;
        document.getElementById('note-aggiuntive').value = reportData.finalNotes.noteAggiuntive;
        document.getElementById('reportDate').textContent = new Date().toLocaleDateString('it-IT');
        
        // Renderizza la checklist
        checklistDiv.innerHTML = '';
        allPhotosDiv.innerHTML = '';

        reportData.checklistItems.forEach(item => {
            // Aggiungi l'elemento alla checklist
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('checklist-item');
            itemDiv.innerHTML = `
                <div class="item-header">
                    <input type="checkbox" checked disabled>
                    <label>${item.description}</label>
                </div>
                <textarea class="item-notes" readonly>${item.notes}</textarea>
            `;
            checklistDiv.appendChild(itemDiv);

            // Aggiungi le foto alla sezione fotografica
            if (item.images && item.images.length > 0) {
                item.images.forEach(imgSrc => {
                    const photoItem = document.createElement('div');
                    photoItem.classList.add('photo-item');
                    photoItem.innerHTML = `
                        <img src="${imgSrc}">
                        <p><b>Dettaglio:</b> ${item.description}</p>
                    `;
                    allPhotosDiv.appendChild(photoItem);
                });
            }
        });
    }

    generatePdfBtn.addEventListener('click', () => {
        // Nascondi il pulsante di generazione PDF prima della stampa
        generatePdfBtn.style.display = 'none';

        const element = document.getElementById('mainReportContent');
        const filename = `Report_${macchinarioField.value.replace(/\s/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
        
        const options = {
            margin: [0, 0, 0, 0], // Margini gestiti dal CSS
            filename: filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(options).from(element).save().then(() => {
            // Ripristina la visibilità del pulsante dopo il salvataggio
            generatePdfBtn.style.display = 'block';
        });
    });

    document.addEventListener('DOMContentLoaded', loadReportData);
</script>
</body>
</html>
